<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LogicBus-Labnotes</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">3.</strong> Hardware</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="qspimem.html"><strong aria-hidden="true">3.1.</strong> QSPIMEM</a></li><li class="chapter-item expanded "><a href="usbcdc.html"><strong aria-hidden="true">3.2.</strong> USB-CDC</a></li><li class="chapter-item expanded "><a href="power-train.html"><strong aria-hidden="true">3.3.</strong> Power-Train</a></li></ol></li><li class="chapter-item expanded "><a href="tools.html"><strong aria-hidden="true">4.</strong> Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="yosys.html"><strong aria-hidden="true">4.1.</strong> Yosys</a></li><li class="chapter-item expanded "><a href="amaranth.html"><strong aria-hidden="true">4.2.</strong> Amaranth</a></li><li class="chapter-item expanded "><a href="blackcrab.html"><strong aria-hidden="true">4.3.</strong> BlackCrab</a></li><li class="chapter-item expanded "><a href="mystorm.html"><strong aria-hidden="true">4.4.</strong> mystorm</a></li></ol></li><li class="chapter-item expanded "><a href="Tiles.html"><strong aria-hidden="true">5.</strong> Tiles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="blinky.html"><strong aria-hidden="true">5.1.</strong> Blinky</a></li><li class="chapter-item expanded "><a href="Seven_Segment.html"><strong aria-hidden="true">5.2.</strong> Seven Segment</a></li><li class="chapter-item expanded "><a href="AV.html"><strong aria-hidden="true">5.3.</strong> Audio &amp; Video</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="audio.html"><strong aria-hidden="true">5.3.1.</strong> Audio</a></li><li class="chapter-item expanded "><a href="video.html"><strong aria-hidden="true">5.3.2.</strong> Video</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="blades.html"><strong aria-hidden="true">6.</strong> Blades</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ledblade.html"><strong aria-hidden="true">6.1.</strong> LedBlade</a></li></ol></li><li class="chapter-item expanded "><a href="reference.html"><strong aria-hidden="true">7.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pll.html"><strong aria-hidden="true">7.1.</strong> PLL</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">LogicBus-Labnotes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lab-notes---introductions"><a class="header" href="#lab-notes---introductions">Lab Notes - Introductions</a></h1>
<p>The documentation is currently under construction and is being developed along with a <a href="https://www.twitch.tv/folknology">live</a> streaming <a href="https://www.youtube.com/playlist?list=PLXS9jyX9czzqn4HU2mEmoEFxpgIv1Dvy7">narrative</a> it is very much a work in progress, you can already find some interesting stuff in the examples section.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<p><a href="https://github.com/folknology/myStorm-Ice-LogicDeck">Ice LogicDeck setup</a>
<a href="https://github.com/folknology/BlackCrab">BlackCrab Firmware</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="icelogicbus-hardware"><a class="header" href="#icelogicbus-hardware">IceLogicBus Hardware</a></h1>
<p>The IceLogicBus (ILB) Hardware consists of modular tiles fitted to the main carrier board as required for the given development project. Onboard the main ILB carrier board is the FPGA and power-train (USB-C-PD/XT30). Mounted on top of this is the BlackEdge Controller (BEC) board with microcontroller, SPI Flash, blades and connectors.</p>
<h2 id="connectivity--power"><a class="header" href="#connectivity--power">Connectivity &amp; Power</a></h2>
<p>The BEC has a USB-C connector configured as a USB CDC serial device running <a href="./qspimem.html">QSPIMEM</a> under <a href="./blackcrab.html">BlackCrab</a> Rust based firmware . This allows programming of the microcontroller, FPGA and flash, along with uart and monitoring features depending on the required mode.</p>
<p>There is a second Usb-C (Usb-PD) Connector on the ILB which operates as a high Power over Usb 
delivery system operating from 5 to 20 volts in order to be able to power a large range of modular tiles from simple led drivers through to small motor and power-train devices. An auxiliary XT30 power connector is also  provided for the more extreme power delivery requirements across the tiles from sources such as batteries etc.</p>
<h2 id="operating-modes"><a class="header" href="#operating-modes">Operating Modes</a></h2>
<p>Mode selection is achieved via the 'Mode' button, if depressed on power up it switches the device into Usb-DFU mode which enables the firmware to be updated from the PC host over Usb. Normal startup places the device into <em><a href="./qspimem.html">QSPIMEM</a></em>. In QSPIMEM mode the device intelligently listens to Usb traffic for new ILB applications, FPGA updates whilst concurrently relaying monitor, logging and error information.</p>
<p>More advanced functionality can be achieved over USB via _<a href="./qspimem.html">QSPIMEM</a> including uploads, downloads and data transfers.</p>
<h2 id="status-and-feedback"><a class="header" href="#status-and-feedback">Status and feedback</a></h2>
<p>There is an RGB led on board which can provide feedback and status of the board's mode and operation. In normal mode this is unlit. if and application or FPGA image is uploaded it will flicker green and amber and then extinguish on successful completion. If it remains red it will normally be due to either a hardware fault or bad FPGA synthesis. A third state is possible when the FPGA synthesis drives the blue part of the led for example in a blinky test, the colour will the blink blue. The BEC also has an RGB led which is normally green (power), the other leds can be used to indicate activity and status from the <a href="./blackcrab.html">BlackCrab</a> firmware.</p>
<p>There is also a 1.27mm pitch 10pin, Arm SWD debug connector if you need to debug what is <a href="./blackcrab.html">BlackCrab</a> running on the BEC.</p>
<p>Setting up IceLogicBus - Drivers and firmware:</p>
<ul>
<li><a href="./qspimem.html">QSPIMEM</a></li>
<li><a href="./usbcdc.html">USB-CDC</a></li>
<li><a href="./usbpd.html">Power Delivery</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qspimem"><a class="header" href="#qspimem">QSPIMEM</a></h1>
<p>QSPIMEM is a simple communications protocol that enables Host&lt;-&gt;BlackIce&lt;-&gt;FPGA transfers and communications. This can be as sinmple as programing the flash or FPGA image or reading and rwriting memory etc..</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usb-cdc"><a class="header" href="#usb-cdc">USB-CDC</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="power-train"><a class="header" href="#power-train">Power-Train</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tools"><a class="header" href="#tools">Tools</a></h1>
<p>Installing the HDL tools:</p>
<ul>
<li><a href="./yosys.html">Yosys</a></li>
<li><a href="./amaranth.html">Amaranth</a></li>
<li><a href="./blackcrab.html">BlackCrab</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="yosys"><a class="header" href="#yosys">Yosys</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="amaranth"><a class="header" href="#amaranth">Amaranth</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blackcrab"><a class="header" href="#blackcrab">BlackCrab</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mystorm"><a class="header" href="#mystorm">mystorm</a></h1>
<p>The mystorm package contains all of the tools and systhesis support for the mystorm hardware including Amaranth board support and PCF filwes for Verilog</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tiles"><a class="header" href="#tiles">Tiles</a></h1>
<h2 id="led-test-example"><a class="header" href="#led-test-example">Led test example</a></h2>
<p>We start with a standard tile resource abstraction to work with a protoboard that I have added 12 LEDS t0. We then run some basic Amaranth python HDL to exercise the leds</p>
<pre><code class="language-python">from amaranth import *
from amaranth.build import *
from IceLogicDeck import *

leds12_tile = [
    Resource(&quot;leds12&quot;, 0,
            Subsignal(&quot;leds&quot;, Pins(&quot;1 2 3 4 5 6 7 8 9 10 11 12&quot;, dir=&quot;o&quot;, conn=(&quot;tile&quot;,2)), Attrs(IO_STANDARD=&quot;SB_LVCMOS&quot;)))
]

class LEDTileTest(Elaboratable):
    def elaborate(self, platform):
        leds12 = Cat([l for l in platform.request(&quot;leds12&quot;)])
        timer = Signal(38)

        m = Module()
        m.d.sync += timer.eq(timer + 1)
        m.d.comb += leds12.eq(timer[-15:-1])
        return m


if __name__ == &quot;__main__&quot;:
    platform = IceLogicDeckPlatform()
    platform.add_resources(leds12_tile)
    platform.build(LEDTileTest(), do_program=True)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blinky"><a class="header" href="#blinky">Blinky</a></h1>
<h2 id="simple-amaranth-blinky-using-the-onboard-led"><a class="header" href="#simple-amaranth-blinky-using-the-onboard-led">Simple Amaranth blinky using the onboard LED</a></h2>
<p>Simple led blinky example using the blue part of the 
rgb led on the Ice LogicDeck.</p>
<pre><code class="language-python">from amaranth import *
from ..boards.icelogicbus import *


class Blink(Elaboratable):
    def elaborate(self, platform):
        led = platform.request(&quot;led&quot;)
        # led = platform.request(&quot;tx&quot;)
        timer = Signal(24)

        m = Module()
        m.d.sync += timer.eq(timer + 1)
        m.d.comb += led.eq(timer[-1])
        return m

def synth():
    platform = IceLogicBusPlatform()
    platform.build(Blink(), do_program=True)


if __name__ == &quot;__main__&quot;:
    synth() 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="seven-segment-tile"><a class="header" href="#seven-segment-tile">Seven Segment Tile</a></h1>
<h2 id="here-is-the-top-level-ahdl-seven_segmentpy"><a class="header" href="#here-is-the-top-level-ahdl-seven_segmentpy">Here is the Top level AHDL Seven_segment.py</a></h2>
<p>Shown below is the Tile example class example we derived from the BlackIce Mx nMigen <a href="https://github.com/lawrie/blackicemx_nmigen_examples/tree/main/seven_segment">examples</a> for the seven segment tile.</p>
<pre><code class="language-python">from amaranth import *
from amaranth.hdl.ast import Rose

from ..boards.icelogicbus import *
from ..tiles.seven_seg_tile import Pins
from ..core.sevensegdecoder import SevenSegDecoder

TILE = 3
segtile = &quot;seven_seg_tile&quot;

class SevenSegExample(Elaboratable):
    def elaborate(self, platform):
        m = Module()
        m.submodules.seven = seven = SevenSegDecoder()

        seg_pins = platform.request(&quot;seven_seg_tile&quot;)
        leds7 = Cat([seg_pins.a, seg_pins.b, seg_pins.c, seg_pins.d, seg_pins.e, seg_pins.f, seg_pins.g])
        timer = Signal(40)
        m.d.sync += timer.eq(timer + 1)

        m.d.comb += [
            leds7.eq(seven.leds)
        ]
        for i in range(3):
            m.d.comb += seg_pins.ca[i].eq(timer[17:19] == i)
            with m.If(seg_pins.ca[i]):
                m.d.comb += seven.val.eq(timer[((i - 3) * 4) - 5:((i - 3) * 4) - 1])

        return m


def synth():
    platform = IceLogicBusPlatform()
    platform.add_tile(segtile, TILE, Pins, invert=True)
    platform.build(SevenSegExample(), do_program=True)

if __name__ == &quot;__main__&quot;:
    synth()
</code></pre>
<h2 id="the-seven-segment-tile-driver"><a class="header" href="#the-seven-segment-tile-driver">The Seven Segment Tile Driver</a></h2>
<p>The tile driver abstracts the tile resource pinouts handling the low level Hex-&gt;7-segment encoding.</p>
<pre><code class="language-python">from typing import List

from amaranth import *
from amaranth.build import *

from ..core.sevensegdecoder import SevenSegDecoder

Pins = {&quot;3 2 1&quot;:(&quot;ca&quot;,&quot;o&quot;),
        &quot;4&quot;:(&quot;g&quot;,&quot;o&quot;),
        &quot;5&quot;:(&quot;f&quot;,&quot;o&quot;),
        &quot;6&quot;:(&quot;a&quot;,&quot;o&quot;),
        &quot;7&quot;:(&quot;e&quot;,&quot;o&quot;),
        &quot;8&quot;:(&quot;b&quot;,&quot;o&quot;),
        &quot;9&quot;:(&quot;dp&quot;,&quot;o&quot;),
        &quot;10&quot;:(&quot;d&quot;,&quot;o&quot;),
        &quot;12&quot;:(&quot;c&quot;,&quot;o&quot;)}


class SevenSegmentTile(Elaboratable):
    def __init__(self):
        self.leds = Signal(7)
        self.ca   = Signal(3)
        self.val  = Signal(12)

    def elaborate(self, platform):
        m = Module()

        m.submodules.seven = seven = SevenSegDecoder()

        m.d.comb += self.leds.eq(seven.leds)

        timer = Signal(19)
        m.d.sync += timer.eq(timer + 1)

        for i in range(3):
            m.d.comb += self.ca[i].eq(timer[17:19] == i)

        with m.If(self.ca[2]):
            m.d.comb += seven.val.eq(self.val[8:])
        with m.If(self.ca[1]):
            m.d.comb += seven.val.eq(self.val[4:8])
        with m.If(self.ca[0]):
            m.d.comb += seven.val.eq(self.val[:4])

        return m

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="audio-and-video-tile"><a class="header" href="#audio-and-video-tile">Audio and Video Tile</a></h1>
<h2 id="vga-vga-driver-and-timings-ahdl"><a class="header" href="#vga-vga-driver-and-timings-ahdl">VGA VGA Driver and Timings AHDL</a></h2>
<pre><code class="language-python">Pins= {&quot;1&quot; : (&quot;hs&quot;, &quot;o&quot;),
       &quot;2&quot; : (&quot;vs&quot;, &quot;o&quot;),
       &quot;11 7 6&quot; : (&quot;red&quot;, &quot;o&quot;),
       &quot;12 10 5 4&quot; : (&quot;green&quot;, &quot;o&quot;), 
       &quot;3 9 8&quot; : (&quot;blue&quot;,&quot;o&quot;)}

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="audio"><a class="header" href="#audio">Audio</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="video"><a class="header" href="#video">Video</a></h1>
<h2 id="how-a-vga-frame-is-divided"><a class="header" href="#how-a-vga-frame-is-divided">How a VGA frame is divided</a></h2>
<p><img src="visual_Frame.png" alt="frame" /></p>
<h2 id="the-vga-signals"><a class="header" href="#the-vga-signals">The VGA Signals</a></h2>
<p><img src="vga_frame.png" alt="signal" /></p>
<h2 id="vga-example-ahdl"><a class="header" href="#vga-example-ahdl">VGA Example AHDL</a></h2>
<pre><code class="language-python">from amaranth import *

from ..boards.icelogicbus import *
from ..tiles.vga_tile import Pins
from ..core.vga import VGADriver, VGATestPattern, VGATiming, vga_timings
from ..core.pll import PLL


TILE = 1
vga_tile = &quot;vga_tile&quot;


class VGAExample(Elaboratable):
    def __init__(self,
                 timing: VGATiming,  # VGATiming class
                 xadjustf=0,  # adjust -3..3 if no picture
                 yadjustf=0):  # or to fine-tune f
        # Configuration
        self.timing = timing
        self.xadjustf = xadjustf
        self.yadjustf = yadjustf

    def elaborate(self, platform):
        m = Module()
        clk_in = platform.request(platform.default_clk, dir='-')[0]
        # Clock generator.
        m.domains.sync = cd_sync = ClockDomain(&quot;sync&quot;)
        m.d.comb += ClockSignal().eq(clk_in)
        # Create a Pll to generate the pixel clock
        m.submodules.pll = pll = PLL(freq_in_mhz=int(platform.default_clk_frequency / 1000000),
                                     freq_out_mhz=int(self.timing.pixel_freq / 1000000),
                                     domain_name=&quot;pixel&quot;)
        # Add the pixel clock domain to the module, and connect input clock
        m.domains.pixel = cd_pixel = pll.domain
        m.d.comb += pll.clk_pin.eq(clk_in)
        platform.add_clock_constraint(cd_pixel.clk, self.timing.pixel_freq)
        # Create VGA instance with chosen timings
        m.submodules.vga = vga = VGADriver(
            self.timing,
            bits_x=16,  # Play around with the sizes because sometimes
            bits_y=16  # a smaller/larger value will make it pass timing.
        )
        # Create test pattern
        m.submodules.pattern = pattern = VGATestPattern(vga)
        # enable the clock and test signal
        m.d.comb += vga.i_clk_en.eq(1)
        # Grab our VGA Tile resource
        av_tile = platform.request(vga_tile)
        # Hook it up to the VGA instance
        m.d.comb += [
            av_tile.red.eq(vga.o_vga_r[5:]),
            av_tile.green.eq(vga.o_vga_g[4:]),
            av_tile.blue.eq(vga.o_vga_b[5:]),
            av_tile.hs.eq(vga.o_vga_hsync),
            av_tile.vs.eq(vga.o_vga_vsync)
        ]

        return m


def synth():
    platform = IceLogicBusPlatform()
    platform.add_tile(vga_tile, TILE, Pins)
    platform.build(VGAExample(timing=vga_timings['1024x768@60Hz']), do_program=True)



if __name__ == &quot;__main__&quot;:
    synth()

</code></pre>
<h2 id="vga-driver-and-timings-ahdl"><a class="header" href="#vga-driver-and-timings-ahdl">VGA Driver and Timings AHDL</a></h2>
<pre><code class="language-python">from typing import NamedTuple

from amaranth import *
from amaranth.build import *

# Abstracts the VGA Frame timing sections
class VGATiming(NamedTuple):
    x: int
    y: int
    refresh_rate: float
    pixel_freq: int
    h_front_porch: int
    h_sync_pulse: int
    h_back_porch: int
    v_front_porch: int
    v_sync_pulse: int
    v_back_porch: int


# Generates a VGA picture from sequential bitmap data from pixel clock
# synchronous FIFO.
#
# The pixel data in i_r, i_g, and i_b registers
# should be present ahead of time.
#
# Signal 'o_fetch_next' is set high for 1 'pixel' clock
# period as soon as current pixel data is consumed.
# The FIFO should be fast enough to fetch new data
# for the new pixel.
class VGADriver(Elaboratable):
    def __init__(self, timing: VGATiming,
                 bits_x            = 10, # should fit resolution_x + hsync_front_porch + hsync_pulse + hsync_back_porch
                 bits_y            = 10, # should fit resolution_y + vsync_front_porch + vsync_pulse + vsync_back_porch
                 ):
        # ClockEnable and Colour Pixel input signals
        self.i_clk_en       = Signal()
        self.i_r            = Signal(8)
        self.i_g            = Signal(8)
        self.i_b            = Signal(8)
        # Frame Buffer timing signals
        self.o_fetch_next   = Signal()
        self.o_beam_x       = Signal(bits_x)
        self.o_beam_y       = Signal(bits_y)
        # Output Blanking signals
        self.o_vga_vblank = Signal()
        self.o_vga_blank = Signal()
        self.o_vga_de = Signal()
        # Output signals for driving DAC/SYNC
        self.o_vga_r = Signal(8)
        self.o_vga_g = Signal(8)
        self.o_vga_b = Signal(8)
        self.o_vga_hsync = Signal()
        self.o_vga_vsync = Signal()
        # Timing constants
        self.timing = timing
        # Configuration
        self.bits_x = bits_x
        self.bits_y = bits_y

    def elaborate(self, platform: Platform) -&gt; Module:
        m = Module()

        # Constants
        C_hblank_on = C(self.timing.x - 1, unsigned(self.bits_x))
        C_hsync_on = C(self.timing.x + self.timing.h_front_porch - 1, unsigned(self.bits_x))
        C_hsync_off = C(self.timing.x + self.timing.h_front_porch + self.timing.h_sync_pulse - 1, unsigned(self.bits_x))
        C_hblank_off = C(self.timing.x + self.timing.h_front_porch + self.timing.h_sync_pulse + self.timing.h_back_porch - 1, unsigned(self.bits_x))
        C_frame_x = C_hblank_off
        # frame x = 640 + 16 + 96 + 48 = 800

        C_vblank_on = C(self.timing.y - 1, unsigned(self.bits_y))
        C_vsync_on = C(self.timing.y + self.timing.v_front_porch - 1, unsigned(self.bits_y))
        C_vsync_off = C(self.timing.y + self.timing.v_front_porch + self.timing.v_sync_pulse - 1, unsigned(self.bits_y))
        C_vblank_off = C(self.timing.y + self.timing.v_front_porch + self.timing.v_sync_pulse + self.timing.v_back_porch - 1, unsigned(self.bits_y))
        C_frame_y = C_vblank_off
        # frame y = 480 + 10 + 2 + 33 = 525
        # refresh rate = pixel clock / (frame x * frame y) = 25 MHz / (800 * 525) = 59.52 Hz

        # Internal signals
        R_hsync = Signal()
        R_vsync = Signal()
        R_disp = Signal() # disp == not blank
        R_disp_early = Signal()
        R_vdisp = Signal()
        R_blank_early = Signal()
        R_vblank = Signal()
        R_fetch_next = Signal()
        CounterX = Signal(self.bits_x)
        CounterY = Signal(self.bits_y)
        R_blank = Signal()

        with m.If(self.i_clk_en):
            with m.If(CounterX == C_frame_x):
                m.d.pixel += CounterX.eq(0)

                with m.If(CounterY == C_frame_y):
                    m.d.pixel += CounterY.eq(0)
                with m.Else():
                    m.d.pixel += CounterY.eq(CounterY + 1)
            with m.Else():
                m.d.pixel += CounterX.eq(CounterX + 1)

            m.d.pixel += R_fetch_next.eq(R_disp_early)
        with m.Else():
            m.d.pixel += R_fetch_next.eq(0)

        m.d.comb += [
            self.o_beam_x.eq(CounterX),
            self.o_beam_y.eq(CounterY),
            self.o_fetch_next.eq(R_fetch_next),
        ]

        # Generate sync and blank.
        with m.If(CounterX == C_hblank_on):
            m.d.pixel += [
                R_blank_early.eq(1),
                R_disp_early.eq(0)
            ]
        with m.Elif(CounterX == C_hblank_off):
            m.d.pixel += [
                R_blank_early.eq(R_vblank),
                R_disp_early.eq(R_vdisp)
            ]
        with m.If(CounterX == C_hsync_on):
            m.d.pixel += R_hsync.eq(1)
        with m.Elif(CounterX == C_hsync_off):
            m.d.pixel += R_hsync.eq(0)

        with m.If(CounterY == C_vblank_on):
            m.d.pixel += [
                R_vblank.eq(1),
                R_vdisp.eq(0)
            ]
        with m.Elif(CounterY == C_vblank_off):
            m.d.pixel += [
                R_vblank.eq(0),
                R_vdisp.eq(1)
            ]
        with m.If(CounterY == C_vsync_on):
            m.d.pixel += R_vsync.eq(1)
        with m.Elif(CounterY == C_vsync_off):
            m.d.pixel += R_vsync.eq(0)

        m.d.pixel += R_blank.eq(R_blank_early)
        m.d.pixel += R_disp.eq(R_disp_early)

        m.d.comb += [
            self.o_vga_r.eq(self.i_r),
            self.o_vga_g.eq(self.i_g),
            self.o_vga_b.eq(self.i_b),
            self.o_vga_hsync.eq(R_hsync),
            self.o_vga_vsync.eq(R_vsync),
            self.o_vga_blank.eq(R_blank),
            self.o_vga_de.eq(R_disp),
        ]

        return m

# Generates a VGA Test Pattern
class VGATestPattern(Elaboratable):
    def __init__(self, vga: VGADriver):
        self.vga = vga

    def elaborate(self, platform: Platform) -&gt; Module:
        W = Signal(8)
        A = Signal(8)
        T = Signal(8)
        Z = Signal(6)
        m = Module()

        # Test pattern fundamentals
        m.d.comb += [
            A.eq(Mux(
                (self.vga.o_beam_x[5:8] == 0b010) &amp; (self.vga.o_beam_y[5:8] == 0b010),
                0xFF, 0)),
            W.eq(Mux(
                (self.vga.o_beam_x[:8] == self.vga.o_beam_y[:8]),
                0xFF, 0)),
            Z.eq(Mux(
                (self.vga.o_beam_y[3:5] == ~(self.vga.o_beam_x[3:5])),
                0xFF, 0)),
            T.eq(Repl(self.vga.o_beam_y[6], len(T))),
        ]

        # Mux Emit rgb test pattern pixels unless within blanking period
        with m.If(self.vga.o_vga_blank):
            m.d.pixel += [
                self.vga.i_r.eq(0),
                self.vga.i_g.eq(0),
                self.vga.i_b.eq(0),
            ]
        with m.Else():
            m.d.pixel += [
                self.vga.i_r.eq((Cat(0b00, self.vga.o_beam_x[:6] &amp; Z) | W) &amp; (~A)),
                self.vga.i_g.eq(((self.vga.o_beam_x[:8] &amp; T) | W) &amp; (~A)),
                self.vga.i_b.eq(self.vga.o_beam_x[:8] | W | A),
            ]

        return m

vga_timings = {
     '640x350@70Hz': VGATiming(
        x             = 640,
        y             = 350,
        refresh_rate  = 70.0,
        pixel_freq    = 25_175_000,
        h_front_porch = 16,
        h_sync_pulse  = 96,
        h_back_porch  = 48,
        v_front_porch = 37,
        v_sync_pulse  = 2,
        v_back_porch  = 60),
    '640x350@85Hz': VGATiming(
        x             = 640,
        y             = 350,
        refresh_rate  = 85.0,
        pixel_freq    = 31_500_000,
        h_front_porch = 32,
        h_sync_pulse  = 64,
        h_back_porch  = 96,
        v_front_porch = 32,
        v_sync_pulse  = 3,
        v_back_porch  = 60),
    '640x400@70Hz': VGATiming(
        x             = 640,
        y             = 400,
        refresh_rate  = 70.0,
        pixel_freq    = 25_175_000,
        h_front_porch = 16,
        h_sync_pulse  = 96,
        h_back_porch  = 48,
        v_front_porch = 12,
        v_sync_pulse  = 2,
        v_back_porch  = 35),
    '640x400@85Hz': VGATiming(
        x             = 640,
        y             = 400,
        refresh_rate  = 85.0,
        pixel_freq    = 31_500_000,
        h_front_porch = 32,
        h_sync_pulse  = 64,
        h_back_porch  = 96,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 41),
    '640x480@60Hz': VGATiming(
        x             = 640,
        y             = 480,
        refresh_rate  = 60.0,
        pixel_freq    = 25_175_000,
        h_front_porch = 16,
        h_sync_pulse  = 96,
        h_back_porch  = 48,
        v_front_porch = 10,
        v_sync_pulse  = 2,
        v_back_porch  = 33),
    '720x400@85Hz': VGATiming(
        x             = 720,
        y             = 400,
        refresh_rate  = 85.0,
        pixel_freq    = 35_500_000,
        h_front_porch = 36,
        h_sync_pulse  = 72,
        h_back_porch  = 108,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 42),
    '768x576@60Hz': VGATiming(
        x             = 758,
        y             = 576,
        refresh_rate  = 60.0,
        pixel_freq    = 34_960_000,
        h_front_porch = 24,
        h_sync_pulse  = 80,
        h_back_porch  = 104,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 17),
    '768x576@72Hz': VGATiming(
        x             = 758,
        y             = 576,
        refresh_rate  = 72.0,
        pixel_freq    = 42_930_000,
        h_front_porch = 32,
        h_sync_pulse  = 80,
        h_back_porch  = 112,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 21),
    '768x576@75Hz': VGATiming(
        x             = 758,
        y             = 576,
        refresh_rate  = 75.0,
        pixel_freq    = 45_510_000,
        h_front_porch = 40,
        h_sync_pulse  = 80,
        h_back_porch  = 120,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 22),
    '800x600@60Hz': VGATiming(
        x             = 800,
        y             = 600,
        refresh_rate  = 60.0,
        pixel_freq    = 40_000_000,
        h_front_porch = 40,
        h_sync_pulse  = 128,
        h_back_porch  = 88,
        v_front_porch = 1,
        v_sync_pulse  = 4,
        v_back_porch  = 23),
    '848x480@60Hz': VGATiming(
        x             = 848,
        y             = 480,
        refresh_rate  = 60.0,
        pixel_freq    = 33_750_000,
        h_front_porch = 16,
        h_sync_pulse  = 112,
        h_back_porch  = 112,
        v_front_porch = 6,
        v_sync_pulse  = 8,
        v_back_porch  = 23),
    '1024x768@60Hz': VGATiming(
        x             = 1024,
        y             = 768,
        refresh_rate  = 60.0,
        pixel_freq    = 65_000_000,
        h_front_porch = 24,
        h_sync_pulse  = 136,
        h_back_porch  = 160,
        v_front_porch = 3,
        v_sync_pulse  = 6,
        v_back_porch  = 29),
    '1152x864@60Hz': VGATiming(
        x             = 1152,
        y             = 864,
        refresh_rate  = 60.0,
        pixel_freq    = 81_620_000,
        h_front_porch = 64,
        h_sync_pulse  = 120,
        h_back_porch  = 184,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 27),
    '1280x720@60Hz': VGATiming(
        x             = 1280,
        y             = 720,
        refresh_rate  = 60.0,
        pixel_freq    = 74_250_000,
        h_front_porch = 110,
        h_sync_pulse  = 40,
        h_back_porch  = 220,
        v_front_porch = 5,
        v_sync_pulse  = 5,
        v_back_porch  = 20),
    '1280x768@60Hz': VGATiming(
        x             = 1280,
        y             = 768,
        refresh_rate  = 60.0,
        pixel_freq    = 79_500_000,
        h_front_porch = 64,
        h_sync_pulse  = 128,
        h_back_porch  = 192,
        v_front_porch = 3,
        v_sync_pulse  = 7,
        v_back_porch  = 20),
    '1280x768@60Hz CVT-RB': VGATiming(
        x             = 1280,
        y             = 768,
        refresh_rate  = 60.0,
        pixel_freq    = 68_250_000,
        h_front_porch = 48,
        h_sync_pulse  = 32,
        h_back_porch  = 80,
        v_front_porch = 3,
        v_sync_pulse  = 7,
        v_back_porch  = 12),
    '1280x800@60Hz': VGATiming(
        x             = 1280,
        y             = 800,
        refresh_rate  = 60.0,
        pixel_freq    = 83_500_000,
        h_front_porch = 72,
        h_sync_pulse  = 128,
        h_back_porch  = 200,
        v_front_porch = 3,
        v_sync_pulse  = 6,
        v_back_porch  = 22),
    '1280x800@60Hz CVT-RB': VGATiming(
        x             = 1280,
        y             = 800,
        refresh_rate  = 60.0,
        pixel_freq    = 71_000_000,
        h_front_porch = 48,
        h_sync_pulse  = 32,
        h_back_porch  = 80,
        v_front_porch = 3,
        v_sync_pulse  = 6,
        v_back_porch  = 14),
    '1280x1024@60Hz': VGATiming(
        x             = 1280,
        y             = 1024,
        refresh_rate  = 60.0,
        pixel_freq    = 108e6,
        h_front_porch = 48,
        h_sync_pulse  = 112,
        h_back_porch  = 248,
        v_front_porch = 1,
        v_sync_pulse  = 3,
        v_back_porch  = 38),
    '1366x768@60Hz': VGATiming(
        x             = 1366,
        y             = 768,
        refresh_rate  = 60.0,
        pixel_freq    = 85_500_000,
        h_front_porch = 70,
        h_sync_pulse  = 143,
        h_back_porch  = 213,
        v_front_porch = 3,
        v_sync_pulse  = 3,
        v_back_porch  = 24),
    '1920x1080@30Hz': VGATiming(
        x             = 1920,
        y             = 1080,
        refresh_rate  = 30.0,
        pixel_freq    = 148_500_000//2,
        h_front_porch = 88,
        h_sync_pulse  = 44,
        h_back_porch  = 148,
        v_front_porch = 4,
        v_sync_pulse  = 5,
        v_back_porch  = 36),
    '1920x1080@30Hz CVT-RB': VGATiming(
        x             = 1920,
        y             = 1080,
        refresh_rate  = 30.0,
        pixel_freq    = 73_000_000,
        h_front_porch = 48,
        h_sync_pulse  = 32,
        h_back_porch  = 80,
        v_front_porch = 3,
        v_sync_pulse  = 5,
        v_back_porch  = 9),
    '1920x1080@30Hz CVT-RB2': VGATiming(
        x             = 1920,
        y             = 1080,
        refresh_rate  = 30.0,
        pixel_freq    = 70_208_000,
        h_front_porch = 8,
        h_sync_pulse  = 32,
        h_back_porch  = 40,
        v_front_porch = 3,
        v_sync_pulse  = 8,
        v_back_porch  = 6),
    '1920x1080@60Hz': VGATiming(
        x             = 1920,
        y             = 1080,
        refresh_rate  = 60.0,
        pixel_freq    = 148_500_000,
        h_front_porch = 88,
        h_sync_pulse  = 44,
        h_back_porch  = 148,
        v_front_porch = 4,
        v_sync_pulse  = 5,
        v_back_porch  = 36),
}
</code></pre>
<p><a href="https://github.com/lawrie/blackicemx_nmigen_examples/tree/main/simple_vga">Code we ported from Lawrie</a> which in turn was built on 
<a href="https://github.com/GuzTech/ulx3s-nmigen-examples/tree/master/dvi">Guztech's VGA for ULX3s</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blades"><a class="header" href="#blades">Blades</a></h1>
<p>Blades are Tiny expansion boards that fit into SDCard like sockets. They are gerat for small connector less applications like adding Wifi, IMUs, QSPI Flash/RAM or even fpc connected SPI Oleds/Lcds. </p>
<p>Each Blade has up to 6 Programable IOs connected directly to the FPGA and can therefor be used for any synthesised digital logic function.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ledblade"><a class="header" href="#ledblade">LEDBlade</a></h1>
<p>The LED Blade sports 6  leds two red, amber and green and can be used for indicating states or patterns as required. Below shows an example of using the led blade.</p>
<pre><code class="language-python">from amaranth import *
from amaranth.build import *

from ..boards.icelogicbus import *

BLADE = 1
leds = &quot;leds6&quot;

class LedBlade(Elaboratable):

    def elaborate(self, platform):
        leds6 = Signal(6, reset = 0b1111)
        leds6 = Cat([l for l in platform.request(leds)])
        timer = Signal(23)

        m = Module()
        m.d.sync += timer.eq(timer + 1)
        with m.If(timer[-1]):
            m.d.sync += leds6.eq(Cat(leds6[1:6], ~leds6[0]))

        return m

def synth():
    platform = IceLogicBusPlatform()
    platform.add_blade(leds, BLADE, {&quot;1&quot;:(&quot;sig&quot;,&quot;o&quot;)})
    platform.build(LedBlade(), do_program=True)

if __name__ == &quot;__main__&quot;:
    synth()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference"><a class="header" href="#reference">Reference</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pll"><a class="header" href="#pll">PLL</a></h1>
<p>The FPGA boards have fixed frequency clocks as inputs generated externally.</p>
<p>Very often, we want to run part or all of our logic at a different clock speed.</p>
<p>This is where PLLs (Phase Locked Loop) enter the picture. It's a fundamental building block, present is most chips of some complexity, that can be configured to generate a clock with a wide range of frequencies.</p>
<p>The ICE40 HX4K FPGA on your board has 2 such PLLs.</p>
<h1 id="pll-example"><a class="header" href="#pll-example">PLL Example</a></h1>
<pre><code class="language-python">from collections import namedtuple
import warnings

from amaranth import *
from amaranth.lib.cdc import ResetSynchronizer
from amaranth.cli import main


class PLL(Elaboratable):
    &quot;&quot;&quot;
    Instantiate the iCE40's phase-locked loop (PLL).
    This uses the iCE40's SB_PLL40_PAD primitive in simple feedback
    mode.
    The reference clock is directly connected to a package pin. To
    allocate that pin, request the pin with dir='-'; otherwise nMigen
    inserts an SB_IO on the pin.  E.g.,
        clk_pin = platform.request('clk12', dir='-')
    Because the PLL eats the external clock, that clock is not available
    for other uses.  So you might as well have the PLL generate the
    default 'sync' clock domain.
    This module also has a reset synchronizer -- the domain's reset line
    is not released until a few clocks after the PLL lock signal is
    good.
    &quot;&quot;&quot;

    def __init__(self, freq_in_mhz, freq_out_mhz, domain_name='sync'):
        self.freq_in = freq_in_mhz
        self.freq_out = freq_out_mhz
        self.coeff = self._calc_freq_coefficients()
        print(self.coeff)
        self.clk_pin = Signal()
        self.rst_pin = Signal()
        self.domain_name = domain_name
        self.domain = ClockDomain(domain_name)
        self.ports = [
            self.clk_pin,
            self.domain.clk,
            self.domain.rst,
        ]
        self.locked = Signal()

    def _calc_freq_coefficients(self):
        # cribbed from Icestorm's icepll.
        f_in, f_req = self.freq_in, self.freq_out
        assert 16 &lt;= f_in &lt;= 100
        assert 16 &lt;= f_req &lt;= 275
        coefficients = namedtuple('coefficients', 'divr divf divq')
        divf_range = 128  # see comments in icepll.cc
        best_fout = float('inf')
        for divr in range(16):
            pfd = f_in / (divr + 1)
            if 10 &lt;= pfd &lt;= 133:
                for divf in range(divf_range):
                    vco = pfd * (divf + 1)
                    if 533 &lt;= vco &lt;= 1066:
                        for divq in range(1, 7):
                            fout = vco * 2 ** -divq
                            if abs(fout - f_req) &lt; abs(best_fout - f_req):
                                best_fout = fout
                                best = coefficients(divr, divf, divq)
        if best_fout != f_req:
            warnings.warn(
                f'PLL: requested {f_req} MHz, got {best_fout} MHz)',
                stacklevel=3)
        return best

    def elaborate(self, platform):

        pll_lock = Signal()

        f_pfd = self.freq_in / (self.coeff.divr + 1);

        if f_pfd &lt; 17:
            filt_range = 1
        elif f_pfd &lt; 26:
            filt_range = 2
        elif f_pfd &lt; 44:
            filt_range = 3
        elif f_pfd &lt; 66:
            filt_range = 4
        elif f_pfd &lt; 101:
            filt_range = 5
        else:
            filt_range = 6

        print(&quot;filter range&quot;, filt_range)

        pll = Instance(&quot;SB_PLL40_CORE&quot;,  # &quot;SB_PLL40_PAD&quot; for up5k
                       p_FEEDBACK_PATH='SIMPLE',
                       p_DIVR=self.coeff.divr,
                       p_DIVF=self.coeff.divf,
                       p_DIVQ=self.coeff.divq,
                       p_FILTER_RANGE=filt_range,

                       ##i_PACKAGEPIN=self.clk_pin, for up5k
                       i_REFERENCECLK=self.clk_pin,
                       i_RESETB=Const(1),
                       i_BYPASS=Const(0),

                       o_PLLOUTGLOBAL=ClockSignal(self.domain_name),
                       o_LOCK=pll_lock)
        rs = ResetSynchronizer(~pll_lock | self.rst_pin, domain=self.domain_name)

        m = Module()
        m.submodules += [pll, rs]

        m.d.comb += self.locked.eq(pll_lock)

        return m


# There is no point in simulating this, but you can generate Verilog.

if __name__ == '__main__':
    pll = PLL(12, 30)
    main(pll, ports=pll.ports)
</code></pre>
<p>A more detailed explanation of the <a href="https://github.com/mystorm-org/BlackIce-II/wiki/PLLs">Ice40HX PLLs</a> from the BlackIce II wiki</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
