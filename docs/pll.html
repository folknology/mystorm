<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PLL - LogicBus-Labnotes</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">3.</strong> Hardware</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="qspimem.html"><strong aria-hidden="true">3.1.</strong> QSPIMEM</a></li><li class="chapter-item expanded "><a href="usbcdc.html"><strong aria-hidden="true">3.2.</strong> USB-CDC</a></li><li class="chapter-item expanded "><a href="power-train.html"><strong aria-hidden="true">3.3.</strong> Power-Train</a></li></ol></li><li class="chapter-item expanded "><a href="tools.html"><strong aria-hidden="true">4.</strong> Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="yosys.html"><strong aria-hidden="true">4.1.</strong> Yosys</a></li><li class="chapter-item expanded "><a href="amaranth.html"><strong aria-hidden="true">4.2.</strong> Amaranth</a></li><li class="chapter-item expanded "><a href="blackcrab.html"><strong aria-hidden="true">4.3.</strong> BlackCrab</a></li><li class="chapter-item expanded "><a href="mystorm.html"><strong aria-hidden="true">4.4.</strong> mystorm</a></li></ol></li><li class="chapter-item expanded "><a href="Tiles.html"><strong aria-hidden="true">5.</strong> Tiles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="blinky.html"><strong aria-hidden="true">5.1.</strong> Blinky</a></li><li class="chapter-item expanded "><a href="Seven_Segment.html"><strong aria-hidden="true">5.2.</strong> Seven Segment</a></li><li class="chapter-item expanded "><a href="AV.html"><strong aria-hidden="true">5.3.</strong> Audio &amp; Video</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="audio.html"><strong aria-hidden="true">5.3.1.</strong> Audio</a></li><li class="chapter-item expanded "><a href="video.html"><strong aria-hidden="true">5.3.2.</strong> Video</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="blades.html"><strong aria-hidden="true">6.</strong> Blades</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ledblade.html"><strong aria-hidden="true">6.1.</strong> LedBlade</a></li></ol></li><li class="chapter-item expanded "><a href="reference.html"><strong aria-hidden="true">7.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pll.html" class="active"><strong aria-hidden="true">7.1.</strong> PLL</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">LogicBus-Labnotes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pll"><a class="header" href="#pll">PLL</a></h1>
<p>The FPGA boards have fixed frequency clocks as inputs generated externally.</p>
<p>Very often, we want to run part or all of our logic at a different clock speed.</p>
<p>This is where PLLs (Phase Locked Loop) enter the picture. It's a fundamental building block, present is most chips of some complexity, that can be configured to generate a clock with a wide range of frequencies.</p>
<p>The ICE40 HX4K FPGA on your board has 2 such PLLs.</p>
<h1 id="pll-example"><a class="header" href="#pll-example">PLL Example</a></h1>
<pre><code class="language-python">from collections import namedtuple
import warnings

from amaranth import *
from amaranth.lib.cdc import ResetSynchronizer
from amaranth.cli import main


class PLL(Elaboratable):
    &quot;&quot;&quot;
    Instantiate the iCE40's phase-locked loop (PLL).
    This uses the iCE40's SB_PLL40_PAD primitive in simple feedback
    mode.
    The reference clock is directly connected to a package pin. To
    allocate that pin, request the pin with dir='-'; otherwise nMigen
    inserts an SB_IO on the pin.  E.g.,
        clk_pin = platform.request('clk12', dir='-')
    Because the PLL eats the external clock, that clock is not available
    for other uses.  So you might as well have the PLL generate the
    default 'sync' clock domain.
    This module also has a reset synchronizer -- the domain's reset line
    is not released until a few clocks after the PLL lock signal is
    good.
    &quot;&quot;&quot;

    def __init__(self, freq_in_mhz, freq_out_mhz, domain_name='sync'):
        self.freq_in = freq_in_mhz
        self.freq_out = freq_out_mhz
        self.coeff = self._calc_freq_coefficients()
        print(self.coeff)
        self.clk_pin = Signal()
        self.rst_pin = Signal()
        self.domain_name = domain_name
        self.domain = ClockDomain(domain_name)
        self.ports = [
            self.clk_pin,
            self.domain.clk,
            self.domain.rst,
        ]
        self.locked = Signal()

    def _calc_freq_coefficients(self):
        # cribbed from Icestorm's icepll.
        f_in, f_req = self.freq_in, self.freq_out
        assert 16 &lt;= f_in &lt;= 100
        assert 16 &lt;= f_req &lt;= 275
        coefficients = namedtuple('coefficients', 'divr divf divq')
        divf_range = 128  # see comments in icepll.cc
        best_fout = float('inf')
        for divr in range(16):
            pfd = f_in / (divr + 1)
            if 10 &lt;= pfd &lt;= 133:
                for divf in range(divf_range):
                    vco = pfd * (divf + 1)
                    if 533 &lt;= vco &lt;= 1066:
                        for divq in range(1, 7):
                            fout = vco * 2 ** -divq
                            if abs(fout - f_req) &lt; abs(best_fout - f_req):
                                best_fout = fout
                                best = coefficients(divr, divf, divq)
        if best_fout != f_req:
            warnings.warn(
                f'PLL: requested {f_req} MHz, got {best_fout} MHz)',
                stacklevel=3)
        return best

    def elaborate(self, platform):

        pll_lock = Signal()

        f_pfd = self.freq_in / (self.coeff.divr + 1);

        if f_pfd &lt; 17:
            filt_range = 1
        elif f_pfd &lt; 26:
            filt_range = 2
        elif f_pfd &lt; 44:
            filt_range = 3
        elif f_pfd &lt; 66:
            filt_range = 4
        elif f_pfd &lt; 101:
            filt_range = 5
        else:
            filt_range = 6

        print(&quot;filter range&quot;, filt_range)

        pll = Instance(&quot;SB_PLL40_CORE&quot;,  # &quot;SB_PLL40_PAD&quot; for up5k
                       p_FEEDBACK_PATH='SIMPLE',
                       p_DIVR=self.coeff.divr,
                       p_DIVF=self.coeff.divf,
                       p_DIVQ=self.coeff.divq,
                       p_FILTER_RANGE=filt_range,

                       ##i_PACKAGEPIN=self.clk_pin, for up5k
                       i_REFERENCECLK=self.clk_pin,
                       i_RESETB=Const(1),
                       i_BYPASS=Const(0),

                       o_PLLOUTGLOBAL=ClockSignal(self.domain_name),
                       o_LOCK=pll_lock)
        rs = ResetSynchronizer(~pll_lock | self.rst_pin, domain=self.domain_name)

        m = Module()
        m.submodules += [pll, rs]

        m.d.comb += self.locked.eq(pll_lock)

        return m


# There is no point in simulating this, but you can generate Verilog.

if __name__ == '__main__':
    pll = PLL(12, 30)
    main(pll, ports=pll.ports)
</code></pre>
<p>A more detailed explanation of the <a href="https://github.com/mystorm-org/BlackIce-II/wiki/PLLs">Ice40HX PLLs</a> from the BlackIce II wiki</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="reference.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="reference.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
